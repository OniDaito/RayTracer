cmake_minimum_required(VERSION 3.0.0)

PROJECT(rays)
include(cmake/RaysVersion.cmake)
include(cmake/RPMPackage.cmake)
include(cmake/BuildInfo.cmake)

# CUDA details
find_package(CUDA QUIET REQUIRED)
option(USE_CUDA "Use CUDA for the raytracing kernel" NO)

# GLM Includes
include_directories( "include/glm" )

# Basic includes
include_directories( "include" )

# Include the binary dir for autogenerated headers
include_directories( ${CMAKE_CURRENT_BINARY_DIR} ) 

# MPI
option(USE_MPI "Use MPI for larger parallel sections" NO)

# OpenMP
option(USE_OPENMP "Use OpenMP for parallel sections" YES)

# Options (gcc mostly) 
SET(CMAKE_CXX_FLAGS "-std=c++11 -static-libstdc++")
SET(CMAKE_CXX_FLAGS_DEBUG "-g -std=c++11 -static-libstdc++")

SET(CMAKE_CXX_FLAGS_PROFILE "-pg")
SET(CMAKE_C_FLAGS_PROFILE "-pg")

# Require MPI for this project or OpenMP or CUDA or all

if (USE_MPI)
  SET(CMAKE_C_COMPILER mpicc)
  SET(CMAKE_CXX_COMPILER mpicxx)
  find_package(MPI REQUIRED)
  set(CMAKE_SHARED_LINKER_FLAGS ${CMAKE_SHARED_LINKER_FLAGS} ${MPI_LINK_FLAGS})
  include_directories(MPI_INCLUDE_PATH)
endif()

# We include this anyways for timing functions
SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fopenmp")

if (USE_CUDA)
  set (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -D_USE_CUDA")
  set(CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS} -D_FORCE_INLINES -O3 -gencode arch=compute_52,code=sm_52)
  CUDA_ADD_EXECUTABLE(rays src/main.cpp src/obj_loader.cpp src/file.cpp src/scene_cuda.cpp src/bmp.cpp src/tracer.cu src/cuda_math.cu)
else()
  ADD_EXECUTABLE(rays src/geometry.cpp src/main.cpp src/obj_loader.cpp src/file.cpp src/scene.cpp src/bmp.cpp src/tracer.cpp)
  target_link_libraries(rays ${MPI_LIBRARIES} X11) 
endif()

